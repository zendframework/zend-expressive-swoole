<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Swoole support for Expressive">  
    <link rel="canonical" href="https://docs.zendframework.com/zend-expressive-swoole/v2/async-tasks/">
    <link rel="shortcut icon" href="../../img/favicon.ico">

    <title>Async Tasks - zend-expressive-swoole - Zend Framework Docs</title>

    <link rel="stylesheet" href="../../css/styles-5cfabd53ee.css">
</head>
<body id="page-top">

    
    <div class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">

            
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            
            <span class="navbar-brand">
                <a class="logo-link" href="https://framework.zend.com/" data-tooltip data-placement="bottom" title="Go to the ZF homepage">
                    <img src="../../img/zend-framework-logo.svg" height="28" alt="Zend Framework">
                </a>
            </span>
        </div>

        <div class="navbar-collapse collapse">

            
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="https://framework.zend.com/about">About</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/downloads">Install</a>
                </li>
                <li class="active">
                    <a href="https://docs.zendframework.com">Documentation</a>
                </li>
                <li>
                    <a href="https://www.zend.com/en/services/training">Training</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/blog">Blog</a>
                </li>
                <li>
                    <a href="https://framework.zend.com/participate">Participate</a>
                </li>
            </ul>

            
            
                <div class="nav navbar-nav navbar-collapse visible-xs-block ">
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">zend-expressive-swoole</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../intro/" class="subnavigation__link">Introduction</a>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Reference</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../static-resources/" class="subnavigation__link">Static Resources</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../logging/" class="subnavigation__link">Logging</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Async Tasks</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../hot-code-reload/" class="subnavigation__link">Hot Code Reloading</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../command-line/" class="subnavigation__link">Command Line Tooling</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../how-it-works/" class="subnavigation__link">How it works</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../considerations/" class="subnavigation__link">Considerations when using Swoole</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../migration/" class="subnavigation__link">Migration</a>
    </li>

            
        </ul>
    </li>

                    
                
            

                
                

                    
                    
                
            
        </ul>
    </div>

                </div>
            

            
            <div class="nav navbar-nav navbar-collapse visible-xs-block">
                <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
            </div>
        </div>
    </div>
</div>

    
    <header class="header">
    <div class="container">
        <div class="row">

            
            <div class="col-xs-8">
                <h1 class="header__title">
                    Documentation

                    
                        <small class="header__subtitle">zend-expressive-swoole</small>
                    
                </h1>
            </div>

            
            <div class="col-xs-4 text-right">
                
                    
<div class="version-selector">
    <div class="btn-group">
        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            
                v2
            
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            
                
                    <li class="dropdown-menu__item dropdown-menu__item--selected">
                        <a href="../intro/">
                            
                                v2 (latest)
                            
                        </a>
                    </li>
                
            
                
                    <li class="dropdown-menu__item">
                        <a href="../../v1/intro/">
                            
                                v1
                            
                        </a>
                    </li>
                
            
        </ul>
    </div>
</div>


                    <a href="#" class="header__link header__link--search" data-toggle="modal" data-target="#mkdocs_search_modal" title="Open search">
                        <i class="fa fa-search"></i> Search
                    </a>
                    <a href="https://github.com/zendframework/zend-expressive-swoole/" class="header__link header__link--github" title="Go to repository of zend-expressive-swoole">
                        <i class="fa fa-github"></i> GitHub
                    </a>
                
            </div>
        </div>
    </div>
</header>

    
    <div class="laminas-announcement">
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                Zend Framework transitions to the Linux Foundation. <a href="https://getlaminas.org">Learn More.</a>
            </div>
        </div>
    </div>
</div>

    
    <div class="container">
        <div class="row">
            <div class="col-md-9 col-xs-12 content" role="main">
            <!-- content:begin -->
                
                    <ol class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation">
    <li><a href="https://framework.zend.com/">Home</a></li>

    
        <li><a href="https://docs.zendframework.com/">Documentation</a></li>

        
            <li><a href="../..">zend-expressive-swoole</a></li>

            
                
                    
                    
                
            
                
                    
                    
                        <li>Reference</li>
                    
                
            

            <li class="active">Async Tasks</li>
        
    
</ol>






    
    
        <h2 class="chapter__headline">Reference</h2>
    

    <div>
        
    

    
    
        <div class="toc">
            <h6 class="toc__headline">In This Article</h6>
            <ul class="toc__list">
                
                    <li class="toc__entry">
                        <a href="#configuring-the-server-process" class="toc__link">Configuring the Server Process</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#task-event-handlers" class="toc__link">Task Event Handlers</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#an-example-task-worker" class="toc__link">An example task worker</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#triggering-tasks-in-middleware" class="toc__link">Triggering Tasks in Middleware</a>
                    </li>
                
            </ul>
        </div>
    

    </div>

    <h1 id="triggering-async-tasks">Triggering Async Tasks</h1>
<p>Application resources requiring lengthy processing are not uncommon. In order to
prevent these processes from impacting user experience, particularly when the
user does not need to wait for the process to complete, we often delegate these
to a <a href="https://en.wikipedia.org/wiki/Message_queue">message queue</a>.</p>
<p>While message queues are powerful, they also require additional infrastructure
for your application, and can be hard to justify when you have a small number of
heavy processes, or a small number of users.</p>
<p>In order to facilitate async processing, Swoole servers provides task worker
processes, allowing your application to trigger tasks without the need for an
external message queue, and without impacting the server worker processes
&mdash; allowing your application to continue responding to requests while the
server processes your task.</p>
<h2 id="configuring-the-server-process">Configuring the Server Process</h2>
<p>In order to take advantage of this feature, you will first need to configure the
server to start up task workers. In your local configuration for the server,
you'll need to add <code>task_worker_num</code>. The number of workers you configure define
the number of concurrent tasks that can be executed at once. Tasks are queued in
the order that they triggered, meaning that a <code>task_worker_num</code> of 1 will offer
no concurrency and tasks will execute one after the other.</p>
<pre class="codehilite"><code class="language-php">'zend-expressive-swoole' =&gt; [
    'swoole-http-server' =&gt; [
        'host' =&gt; '127.0.0.1',
        'port' =&gt; 8080,
        'options' =&gt; [
            'worker_num'      =&gt; 4, // The number of HTTP Server Workers
            'task_worker_num' =&gt; 4, // The number of Task Workers
        ],
    ],
];</code></pre>

<blockquote>
<h3 id="no-cli-option-for-task_worker_num">No CLI option for task_worker_num</h3>
<p>Unlike <code>worker_num</code>, there is no CLI option for <code>task_worker_num</code>. This is
because enabling the task worker also requires registering a task worker
with the server. To prevent accidental startup failures due to passing an
option to specify the number of task workers without having registered a
task worker, we omitted the CLI option.</p>
</blockquote>
<h2 id="task-event-handlers">Task Event Handlers</h2>
<p>When task workers are enabled, the Swoole server will now <strong>require</strong> that you
register two event callbacks with the server; without them, the server will
refuse to start.</p>
<p>The two events are:</p>
<ul>
<li><code>task</code>, which will define the code for handling tasks.</li>
<li><code>finish</code>, which will execute when a task has completed.</li>
</ul>
<h3 id="registering-the-handlers">Registering the Handlers</h3>
<p>The signature for the <code>task</code> event handler is:</p>
<p><pre class="codehilite"><code class="language-php">function (
    \Swoole\Http\Server $server,
    int $taskId,
    int $sourceWorkerId,
    $dataForWorker
) : void</code></pre>
where:</p>
<ul>
<li><code>$server</code> is the main HTTP server process</li>
<li><code>$taskId</code> is a number that increments each time the server triggers a new task.</li>
<li><code>$sourceWorkerId</code> is an integer that defines the worker process that is
  executing the workload.</li>
<li><code>$dataForWorker</code> contains the value passed to the <code>$server-&gt;task()</code> method
  when initially triggering the task. This value can be any PHP value, with the
  exception of a <code>resource</code>.</li>
</ul>
<p>To register the handler with the server, you must call it's <code>on()</code> method,
<strong>before</strong> the server has been started:</p>
<pre class="codehilite"><code class="language-php">$server-&gt;on('task', $callable);</code></pre>

<p>As previously mentioned, you must also register an event handler for the
<code>finish</code> event. This callback for this event should have the following
signature:</p>
<pre class="codehilite"><code class="language-php">function (
    \Swoole\Http\Server $server,
    int $taskId,
    $userData
) : void</code></pre>

<p>The first two parameters are identical to the <code>task</code> event handler. The
<code>$userData</code> parameter will contain the return value of the <code>task</code> event
handler. </p>
<p>Registering your callable for the <code>finish</code> event is accomplished like this:</p>
<pre class="codehilite"><code class="language-php">$server-&gt;on('finish', $callable);</code></pre>

<blockquote>
<h3 id="there-can-be-only-one">There can be only one</h3>
<p>There can be <strong>only one</strong> event handler per event type. Subsequent calls to
<code>on('&lt;EventName&gt;')</code> replace the previously registered callable.</p>
<h3 id="finishing-a-task">Finishing a task</h3>
<p>If you do not return anything from your <code>task</code> event handler, the
<code>finish</code> handler <strong>will not be called</strong>. The Swoole documentation recommends
that the task worker callback manually finish the task in these situations:</p>
<pre class="codehilite"><code class="language-php">$server-&gt;finish('');</code></pre>

<p>Even if you do not call the above method, the handler <strong>must</strong> be defined, or
the server will refuse to start.</p>
</blockquote>
<h2 id="an-example-task-worker">An example task worker</h2>
<p>The following example code illustrates a task worker with logging capabilities
that uses a message notifier to process data:</p>
<pre class="codehilite"><code class="language-php">// In src/App/TaskWorker.php:

namespace App;

use Psr\EventDispatcher\MessageInterface;
use Psr\EventDispatcher\MessageNotifierInterface;
use Psr\Log\LoggerInterface;
use Throwable;

class TaskWorker
{
    private $notifier;
    private $logger;

    public function __construct(LoggerInterface $logger, MessageNotifierInterface $notifier)
    {
        $this-&gt;logger = $logger;
        $this-&gt;notifier = $notifier;
    }

    public function __invoke($server, $taskId, $fromId, $data)
    {
        if (! $data instanceof MessageInterface) {
            $this-&gt;logger-&gt;error('Invalid data type provided to task worker: {type}', [
                'type' =&gt; is_object($data) ? get_class($data) : gettype($data)
            ]);
            return;
        }

        $this-&gt;logger-&gt;notice('Starting work on task {taskId} using data: {data}', [
            'taskId' =&gt; $taskId,
            'data' =&gt; json_encode($data),
        ]);

        try {
            $this-&gt;notifier-&gt;notify($data);
        } catch (Throwable $e) {
            $this-&gt;logger-&gt;error('Error processing task {taskId}: {error}', [
                'taskId' =&gt; $taskId,
                'error' =&gt; $e-&gt;getTraceAsString(),
            ]);
        }

        // Notify the server that processing of the task has finished:
        $server-&gt;finish('');
    }
}</code></pre>

<p>This invokable class needs to be attached to the <code>$server-&gt;on('task')</code> event
before the server has started. The easiest place to accomplish this is in a
<a href="https://docs.zendframework.com/zend-expressive/v3/features/container/delegator-factories/">delegator factory</a>
targeting the Swoole HTTP server. First, we'll create the delegator factory:</p>
<pre class="codehilite"><code class="language-php">// In src/App/TaskWorkerDelegator.php:

namespace App;

use Psr\Container\ContainerInterface;
use Psr\Log\LoggerInterface;
use Swoole\Http\Server as HttpServer;

class TaskWorkerDelegator
{
    public function __invoke(ContainerInterface $container, $serviceName, callable $callback) : HttpServer
    {
        $server = $callback();
        $logger = $container-&gt;get(LoggerInterface::class);

        $server-&gt;on('task', $container-&gt;get(TaskWorker::class));
        $server-&gt;on('finish', function ($server, $taskId, $data) use ($logger) {
            $logger-&gt;notice('Task #{taskId} has finished processing', ['taskId' =&gt; $taskId]);
        });

        return $server;
    }
}</code></pre>

<p>Next, we'll register it with our container:</p>
<pre class="codehilite"><code class="language-php">// In config/autoload/dependencies.php:

return [
    'dependencies' =&gt; [
        'delegators' =&gt; [
            \Swoole\Http\Server::class =&gt; [
                \App\TaskWorkerDelegator::class,
            ],
        ],
    ],
];</code></pre>

<p>With this in place, we can now trigger tasks within our application. In the
scenario outlined above, the task worker expects <em>messages</em>; it then <em>notifies</em>
listeners of that message so they may respond to it.</p>
<h2 id="triggering-tasks-in-middleware">Triggering Tasks in Middleware</h2>
<p>Considering that this library provides an application runner for middleware
applications, you will likely trigger tasks from within your middleware or
request handlers. In each case, you will need to compose the Swoole HTTP server
instance as a class dependency, as tasks are triggered via the server via its
<code>task()</code> method. The method can accept any value except a resource as an
argument.</p>
<p>In the example below, <code>ContactMessage</code> will implement the <code>MessageInterface</code>
from the above example. The request handler uses values from the request to
create the <code>ContactMessage</code> instance, and then create a task from it. It then
immediately returns a response.</p>
<pre class="codehilite"><code class="language-php">// in src/App/Handler/TaskTriggeringHandler.php:

namespace App\Handler;

use Psr\Http\Message\ResponseFactoryInterface;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\RequestHandlerInterface;
use Swoole\Http\Server as HttpServer;
use Zend\Expressive\Template\TemplateRendererInterface;

class TaskTriggeringHandler implements RequestHandlerInterface
{
    private $responseFactory;
    private $server;
    private $template;

    public function __construct(
        HttpServer $server,
        TemplateRendererInterface $template,
        ResponseFactoryInterface $responseFactory
    ) {
        $this-&gt;server          = $server;
        $this-&gt;template        = $template;
        $this-&gt;responseFactory = $responseFactory;
    }

    public function handle(ServerRequestInterface $request) : ResponseInterface
    {
        // Gather data from request
        $data = $request-&gt;getParsedBody();

        // A fictonal event describing a contact request:
        $event = new ContactEvent([
            'to'      =&gt; $data['email'],
            'subject' =&gt; $data['subject'],
            'message' =&gt; $data['message'],
        ]);

        // task() returns a task identifier, if you want to use it; otherwise,
        // you can ignore the return value.
        $taskIdentifier = $this-&gt;server-&gt;task($event);

        // The task() method is asynchronous, so execution continues immediately.
        $response = ($this-&gt;responseFactory()-&gt;createResponse())
            -&gt;withHeader('Content-Type', 'text/html');
        $response-&gt;getBody()-&gt;write($this-&gt;template-&gt;render('contact::thank-you', []);
        return $response;
    }
}</code></pre>




    <nav>
    <ul class="page-nav hidden-print">

        
        <li class="page-nav__item">
            
                <a rel="prev" class="page-nav__link page-nav__link--prev" href="../logging/">
                    <i class="fa fa-chevron-left"></i> Previous
                </a>
            
        </li>

        
        <li class="page-nav__item">
            
                <a rel="next" class="page-nav__link page-nav__link--next" href="../hot-code-reload/">
                    Next <i class="fa fa-chevron-right"></i>
                </a>
            
        </li>
    </ul>
</nav>




    <div class="help-wanted">
        <p>
            Found a mistake or want to contribute to the documentation?
            <a href="https://github.com/zendframework/zend-expressive-swoole/edit/master/docs/v2/async-tasks.md" target="_blank" class="help-wanted__link">
                Edit this page on GitHub!
            </a>
        </p>
    </div>

                
            <!-- content:end -->
            </div>
            <div class="col-md-3 col-xs-12 sidebar">
                
                    <div class="component-selector">
    <h4 class="component-selector__title">Components</h4>
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">zend-expressive-swoole</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../intro/" class="subnavigation__link">Introduction</a>
    </li>

                    
                        
    <li class="subnavigation__list-item">
        <span class="subnavigation__headline">Reference</span>
        <ul class="subnavigation__list">
            
                
    <li class="subnavigation__list-item ">
        <a href="../static-resources/" class="subnavigation__link">Static Resources</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../logging/" class="subnavigation__link">Logging</a>
    </li>

            
                
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Async Tasks</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../hot-code-reload/" class="subnavigation__link">Hot Code Reloading</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../command-line/" class="subnavigation__link">Command Line Tooling</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../how-it-works/" class="subnavigation__link">How it works</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../considerations/" class="subnavigation__link">Considerations when using Swoole</a>
    </li>

            
                
    <li class="subnavigation__list-item ">
        <a href="../migration/" class="subnavigation__link">Migration</a>
    </li>

            
        </ul>
    </li>

                    
                
            

                
                

                    
                    
                
            
        </ul>
    </div>

                
            </div>
        </div>
    </div>

    
    <footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-9">
                <h5>Zend Framework</h5>
                <ul>
                    <li><a href="https://framework.zend.com/">framework.zend.com</a></li>
                    <li><a href="https://docs.zendframework.com">docs.zendframework.com</a></li>
                    <li><a href="https://packages.zendframework.com">packages.zendframework.com</a></li>
                    <li><a href="https://apigility.org">apigility.org</a></li>
                    <li><a href="https://getexpressive.org/">getexpressive.org</a></li>
                </ul>
            </div>
        </div>

        
        <div class="row">
            <div class="col-md-12 text-center">
                <a class="footer__button" href="#page-top"><i class="fa fa-chevron-up" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="row">

            
            <div class="col-md-9">
                <h4 class="footer__headline">Copyright</h4>
                <p>&copy; 2006-2019 by <a href="https://www.zend.com/">Zend</a>, a <a href="https://www.roguewave.com/">Rogue Wave Company</a>.</p>
            </div>

            
            <div class="col-md-3">
                <h4 class="footer__headline">Support</h4>
                <ul class="support__list">
                    <li class="support__list-item">
                        <a href="https://discourse.zendframework.com" class="support__link" title="Forum"><i class="fa fa-comments"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://zendframework-slack.herokuapp.com" class="support__link" title="Chat"><i class="fa fa-slack"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://github.com/zendframework" class="support__link" title="Github"><i class="fa fa-github"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://twitter.com/zfdevteam" class="support__link" title="Twitter"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://tinyletter.com/mwopzend" class="support__link" title="Newsletter"><i class="fa fa-envelope"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://framework.zend.com/blog/feed-rss.xml" class="support__link" title="Blog feed"><i class="fa fa-rss"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://framework.zend.com/security/feed" class="support__link" title="Security feed"><i class="fa fa-rss-square"></i></a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script>
        var base_url = '../..',
            siteName = 'zend-expressive-swoole';
    </script>
    <script src="../../js/scripts-8d7ae56abf.js"></script>
        <script src="../../search/main.js"></script>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>



</body>


</html>
